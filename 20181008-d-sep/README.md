# D-Separationと独立性の関係

Pearl流の因果推論の記事を見ていると必ずと言っていいほど出てくるのがこのD-Separationという言葉だ。日本語ではどうも有向分離と呼ぶらしい。この記事は日本語で書いてあるので、日本語名で呼んで行く事にしよう。基本的にはベイジアンネットワーク上で変数の間の独立性を見つけるための定理なのだが、多くの場合その定理の主張を説明して少し具体例に当てはめて終わってしまい、その証明が抜けていることが多い。あまりにも頻度高く使用される定理なのでその証明くらい知って起きたいなと思いつつ結局そのままにしてきてしまっていたのだが、今回[あるスライド](https://www.cse.ust.hk/bnbook/pdf/l03.h.pdf)を見つけてそこに証明がうまく書かれていたのでまとめてみようと思う。

## 有向分離とは

まずは有向分離の定義から入って行こうと思う。ベイジアンネットワークとかDAG関連の定義を書いておく必要があるかどうかは迷うところだが、書くと本当に長くなるのでここでは説明しない事にする。定義などが必要な場合は[この参考文献](http://www.asakura.co.jp/books/isbn/978-4-254-12781-2/)などを読んでほしい。

> *定義1: ブロック*  
> 非巡回有向グラフ$({\bf V}, {\bf E})$を考える。ある2つの頂点$X$と$Y$を結ぶ道Pが$X$と$Y$を含まない頂点集合$\bf Z$に対して次の二つの条件のどちらかを満たす場合、道Pは頂点集合$\bf Z$によってブロックされるという。

- 道P上の合流点で、その合流点とその子孫が$\bf Z$に含まれないものがある。ただしここで道P上の合流点とはその道上の隣り合った二つの頂点から矢印が向いているような頂点のことである。
- 道P上の非合流点で、$\bf Z$に含まれるものがある。

> *定義2: 有効分離(d-separation)*  
> ある2つの頂点$X$と$Y$を結ぶ任意の道に対して、$X$と$Y$を含まない頂点集合$\bf Z$がそれらを全てブロックする場合、頂点$X$と$Y$は頂点集合$\bf Z$で有向分離されているという。

ブロックの定義が少し複雑なので、証明にも手間取りそうな雰囲気を感じざるを得ないが、有効分離に紐づけられている次の定理の綺麗さを見るとそうでもない可能性もしてくる。

> *定理1: 有効分離と独立性*  
> 頂点$X$と$Y$が頂点集合$\bf Z$で有向分離されていることは以下と同値である。

$$
X \perp\!\!\!\perp Y | \bf Z
$$

要するに、有効分離というのはベイジアンネットワーク上における変数の間の独立性と同値であるという定理が成り立つ。これを見る限りでは非常に綺麗な定理なのだが、いかんせんブロックの定義が少し複雑なので難しい。[この記事](http://machine-learning.hatenablog.com/entry/2016/02/14/123945)は有効分離をとてもよくまとめてくれているので参考になる。

## 有効分離と独立性の関係の証明

証明は先程も挙げた[このスライド](https://www.cse.ust.hk/bnbook/pdf/l03.h.pdf)を元に進めていこうと思う。このスライドは定義や定理を比較的明確に書いてくれているので、これを見て順番に追っていけば理解できるはずではある。基本的にはそちらを参考に理解していこうとは思うが、自分なりにも以下にまとめて行く。とりあえずは基礎的なところから証明して行こう。

> *命題1: 子孫の存在しない頂点はそれ以外の確率分布に影響を与えないこと*  
> ベイジアンネットワーク$\mathcal{N}$について考える。ベイジアンネットワーク$\mathcal{N}'$を$\mathcal{N}$から子孫の存在しない頂点$Y$をのぞいたものとする。この時$\mathcal{N}'$に含まれる変数の集合$\bf X$について

$$
P_{\mathcal{N}}({\bf X}) = P_{\mathcal{N}'}({\bf X})
$$

が成立する。ただしここで$P_{\mathcal{N}}({\bf X})$はベイジアンネットワーク$\mathcal{N}$に付随する、変数${\bf X}$における確率分布である。

これは以下のように証明できる。

$$
\begin{aligned}
P_{\mathcal{N}}({\bf X}) &= \sum_{\bf Y} P_{\mathcal{N}}({\bf X}, Y) \\
&= \sum_{\bf Y} \prod_{W \in {\bf X}}P(W | pa(W)) P(Y | pa(Y)) \\
&= \prod_{W \in {\bf X}}P(W | pa(W)) \sum_{\bf Y} P(Y | pa(Y)) \\
&= \prod_{W \in {\bf X}}P(W | pa(W)) \\
&= P_{\mathcal{N}'}({\bf X})
\end{aligned}
$$

とりあえず基本的なことを証明できたわけだが、ベイジアンネットワークをある程度いじっている人からすれば自明ではある。これをもとにもう少し非自明な内容を示していこう。とりあえず定義を一通り述べた後に、一つ簡単な命題を示す。

> *定義3: 先祖集合(ancestral set)*  
> 非巡回有向グラフ$({\bf V}, {\bf E})$を考える。ある頂点集合${\bf X} \in {\bf V}$に対する祖先集合${\rm an}({\bf X})$とは頂点集合${\bf X}$とその全ての祖先を集めた集合のことである。

> *定義3: 先祖的(ancestral)*  
> もし頂点集合$\bf X$がその先祖集合と一致する ${\bf X} = {\rm an}({\bf X})$ であるならば、その頂点集合は先祖的であるという。

> *命題2: 先祖的な頂点集合の分布はそのほかの頂点の影響を受けない*  
> ベイジアンネットワーク$\mathcal{N}$について考える。ここで頂点集合$\bf X$は先祖的であると仮定する。この時$\mathcal{N}'$を$\mathcal{N}$から$\bf X$以外のノードを全てのぞいたベイジアンネットワークだとすれば、

$$
P_{\mathcal{N}}({\bf X}) = P_{\mathcal{N}'}({\bf X})
$$

が成立する。

このことは次のように証明できる。先祖的な頂点集合$\bf X$以外の頂点から子孫のいないノードを一つ一つ命題1にしたがって削除していけばいずれ$\bf X$に所属しない頂点は削除できる。もしその手順で削除を行っていっても削除できない頂点があった場合、その頂点には最低でも一つ$\bf X$に所属する子孫が存在するはずであるが、その場合その頂点は$\bf X$の先祖となり、$\bf X$が先祖的であることと矛盾する。

次に少し今までとは毛色が違う命題を証明する。

> *命題3*  
> 頂点集合${\bf X}, {\bf Y}, {\bf Z}$は互いに素な頂点集合で、それらの和集合は頂点集合$\bf V$と一致すると仮定する。この時$\bf Z$が$\bf X$と$\bf Y$を有効分離するのならば

$$
X \perp\!\!\!\perp Y | \bf Z
$$

これは以下のように示せる。まず$\bf Z$を親が$\bf X$か$\bf Z$にある頂点の集合${\bf Z}_1$と、親が$\bf Y$か$\bf Z$にある頂点の集合${\bf Z}_2$に分類する。もし$\bf X$と$\bf Y$のどちらにも親がいるような頂点が存在した場合、その頂点は明らかに$\bf X$と$\bf Y$を有効分離しないため仮定に反する。この時、

$$
\begin{aligned}
P({\bf X}, {\bf Y}, {\bf Z}) &= \prod_{W \in {\bf X} \cup {\bf Y} \cup {\bf Z}} P(W | pa(W)) \\
&= [\prod_{W \in {\bf X} \cup {\bf Z}_1} P(W | pa(W))][\prod_{W \in {\bf X} \cup {\bf Z}_2} P(W | pa(W))]
\end{aligned}
$$

と分離することができる。ここで

- $\prod_{W \in {\bf X} \cup {\bf Z}_1} P(W | pa(W))$ は$\bf X$と$\bf Z$の関数
- $\prod_{W \in {\bf X} \cup {\bf Z}_２} P(W | pa(W))$ は$\bf Y$と$\bf Z$の関数

であるから、因数分解基準より題意は示される。

以上で示した命題を使って、最後に有効分離と独立性の証明をする。

> *命題4: 有向分離されている二つの確率変数は独立*  
> $X$と$Y$を確率変数、$\textbf{Z}$をそれらを含まない変数の集合とする。この時、$\textbf{Z}$が$X$と$Y$を有向分離するのならば

$$
X \perp\!\!\!\perp Y | \bf \textbf{Z}
$$

が成り立つ。

この証明を行う。命題2より、以下で考える対象としては$\mathrm{an}(\{X, Y\} \cup \textbf{Z})$に含まれる頂点しか考えなくて良い。それ以外の頂点は全て周辺化されたものとして考える。まずは考察対象の集合を三つに分割して命題3を適用させることを考える。$\textbf{X}$を$X$と$\textbf{Z}$で有向分離されていない頂点の集合だと仮定する。もちろんこの集合には$Y$は入らないし、当然$\textbf{Z}$に含まれる頂点は含まれない。そして、$\textbf{Y}$を$\textbf{X}$にも$\textbf{Z}$にも含まれない頂点の集合とする。明らかに$Y$はその集合に含まれている。

それらの集合は命題3を適用させるための条件を守っているために

$$
\textbf{X} \perp\!\!\!\perp \textbf{Y} | \bf \textbf{Z}
$$

が成立する。よってそれらの同時確率$P(\textbf{X}, \textbf{Y}, \textbf{Z})$は適当な二つの関数$f(\textbf{X}, \textbf{Z})$と$g(\textbf{Y}, \textbf{Z})$によって分解できる

$$
P(\textbf{X}, \textbf{Y}, \textbf{Z}) = f(\textbf{X}, \textbf{Z}) g(\textbf{Y}, \textbf{Z})
$$

あとは、$\textbf{X}$と$\textbf{Y}$に含まれる今回関係ない頂点を周辺化してしまえば

$$
P(X, Y, \textbf{Z}) = f(X, \textbf{Z}) g(Y, \textbf{Z})
$$

と表せるわけだが、これはとりもなおさず

$$
X \perp\!\!\!\perp Y | \bf \textbf{Z}
$$

を意味する。
