HTTPリクエストの遮断の仕方
2018-09-30


backendがデータベースに接続できなかった場合のテストを行いたかったのだが、接続できなかった場合のテストとはどうするのかよくわからなかった。適当にデータベースのパスワードを変更したりして接続を落としたりしていたが、普通はデータベースに接続できないエラーっていうのはそういうものではなくネットワークの異常によって起こるものであろうから、少し違和感を感じていた。


この違和感をぬぐい去るために、データベースにアクセスできないという状況を意図的かつ簡単に作り出す方法はないものか考えてみた。基本的にデータベースにアクセスできないエラーは大抵の場合はネットワークのエラーであろうから、それを模倣できれば良い。Google先生に聞いてみるとどうもiptablesというコマンドでそれと似たようなことができるらしい。


iptablesコマンドは基本的には簡易的なfirewallを作り出せるもので、様々な設定をすることでipアドレスやportに依存してネットワークのアクセスを拒否したり許可したりすることができる。\a{このサイト}{https://www.howtogeek.com/177621/the-beginners-guide-to-iptables-the-linux-firewall/}も同じくわかりやすいが、少し違う点も説明してくれている。


今回はデータベースに繋げなくなれば良いので、そのデータベースが動いているのであろうポートを指定して繋げなくしてやろう。そうすればbackendがデータベースに接続しようとした時には、その接続先ポートにアクセスできなくなっているのでエラーが返ってくるはずだ。例えば、データベースが8000番ポートで動いている時にそこへのbackendからのアクセスを止めたい場合は
\code{
sudo iptables -A OUTPUT -p tcp --dport 8000 -j REJECT
}
とすれば良い。こうすることでbackendからはどんなサーバーの8000番ポートへのtcp接続もできなくなるので、明らかに8000番ポートで動いているデータベースには繋げなくなる。この設定を戻したいときは、
\code{
sudo iptables -D OUTPUT -p tcp --dport 8000 -j REJECT
}
としてやれば元どおりだ。この方法の利点は別の接続には影響を与えない点だ。例えばbackendサーバーが RESTful API をfrontendサーバーに対して表出していたとしても、それらの通信はhttpなら80番ポートで行われるためになんの影響の与えない。これでデータベースへの接続だけを止めるということができるようになる。